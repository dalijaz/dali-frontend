<div class="admin-root">
  <div class="admin-scope">
    <h2 class="title">Questions (Admin)</h2>

    <label class="label">
      Certificate:
      <select class="select" [(ngModel)]="selectedCertId" (change)="onSelectCertificate()">
        <option [ngValue]="null">-- choose --</option>
        <option *ngFor="let c of certificates" [ngValue]="c.id">{{ c.name }}</option>
      </select>
    </label>

    <div *ngIf="loading" class="muted">Loadingâ€¦</div>
    <div *ngIf="!loading && error" class="error">{{ error }}</div>

    <div *ngIf="selectedCertId" class="panel create">
      <h4>Create Question</h4>
      <input class="input" placeholder="Question text" [(ngModel)]="draft.text" name="draftText">

      <div class="grid2">
        <input class="input" placeholder="Option A" [(ngModel)]="draft.optionA" name="draftA">
        <input class="input" placeholder="Option B" [(ngModel)]="draft.optionB" name="draftB">
        <input class="input" placeholder="Option C" [(ngModel)]="draft.optionC" name="draftC">
        <input class="input" placeholder="Option D" [(ngModel)]="draft.optionD" name="draftD">
      </div>

      <div class="line">
        <span>Correct:</span>
        <select class="select" [(ngModel)]="draft.correctIndex" name="draftCorrect">
          <option [ngValue]="0">A</option><option [ngValue]="1">B</option>
          <option [ngValue]="2">C</option><option [ngValue]="3">D</option>
        </select>
        <span>Mark:</span>
        <input class="input small" type="number" min="1" [(ngModel)]="draft.mark" name="draftMark">
        <button class="btn small" (click)="create()">Create</button>
      </div>
    </div>

    <div *ngIf="!loading && !error && questions.length">
      <h4>Questions</h4>
      <div *ngFor="let q of questions; trackBy: trackById" class="qrow">
        <div *ngIf="editingId !== q.id">
          <b>Q:</b> {{ q.text }} <br>
          <div *ngFor="let opt of [q.optionA, q.optionB, q.optionC, q.optionD]; let i = index">
            <span [class.bold]="q.correctIndex === i">
              {{ ['A','B','C','D'][i] }}. {{ opt }} <span *ngIf="q.correctIndex === i">(correct)</span>
            </span>
          </div>
          <div>Mark: {{ q.mark || 1 }}</div>
          <button class="btn small" (click)="startEdit(q)">Edit</button>
          <button class="btn small danger" (click)="remove(q.id!)">Delete</button>
        </div>

        <div *ngIf="editingId === q.id && editBuffer">
          <input class="input" [(ngModel)]="editBuffer.text" name="editText{{q.id}}" placeholder="Question text">

          <div class="grid2">
            <input class="input" [(ngModel)]="editBuffer.optionA" name="editA{{q.id}}" placeholder="Option A">
            <input class="input" [(ngModel)]="editBuffer.optionB" name="editB{{q.id}}" placeholder="Option B">
            <input class="input" [(ngModel)]="editBuffer.optionC" name="editC{{q.id}}" placeholder="Option C">
            <input class="input" [(ngModel)]="editBuffer.optionD" name="editD{{q.id}}" placeholder="Option D">
          </div>

          <div class="line">
            <span>Correct:</span>
            <select class="select" [(ngModel)]="editBuffer.correctIndex" name="editCorrect{{q.id}}">
              <option [ngValue]="0">A</option><option [ngValue]="1">B</option>
              <option [ngValue]="2">C</option><option [ngValue]="3">D</option>
            </select>

            <span>Mark:</span>
            <input class="input small" type="number" min="1" [(ngModel)]="editBuffer.mark" name="editMark{{q.id}}">
          </div>

          <div class="line">
            <button class="btn small" (click)="saveEdit()">Save</button>
            <button class="btn small ghost" (click)="cancelEdit()">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="!loading && !error && selectedCertId && questions.length === 0" class="muted">
      No questions yet for this certificate.
    </div>
  </div>
</div>
